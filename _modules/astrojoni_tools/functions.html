

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>astrojoni_tools.functions &#8212; astrojoni_tools v0.1.0</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/astrojoni_tools/functions';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    <p class="title logo__title">astrojoni_tools v0.1.0</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../modules.html">
                        astrojoni_tools
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../modules.html">
                        astrojoni_tools
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../astrojoni_tools.html" class="nav-link">astrojoni_tools</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">astrojoni_tools.functions</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for astrojoni_tools.functions</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">radio_beam</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span><span class="p">,</span> <span class="n">WCSSUB_SPECTRAL</span>
<span class="kn">from</span> <span class="nn">spectral_cube</span> <span class="kn">import</span> <span class="n">SpectralCube</span><span class="p">,</span> <span class="n">Projection</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian1DKernel</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>

<span class="kn">from</span> <span class="nn">.utils.wcs_utils</span> <span class="kn">import</span> <span class="n">sanitize_wcs</span>



<div class="viewcode-block" id="getting_ready"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.getting_ready">[docs]</a><span class="k">def</span> <span class="nf">getting_ready</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">banner</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;=&#39;</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">banner</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">string</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">banner</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_nearest"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.find_nearest">[docs]</a><span class="k">def</span> <span class="nf">find_nearest</span><span class="p">(</span><span class="n">array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the index of an element in an array nearest to a given value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    array : numpy.ndarray</span>
<span class="sd">        Input array to index.</span>
<span class="sd">    value : float</span>
<span class="sd">        Value of the element to find the closest index for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    idx : int</span>
<span class="sd">        Index of the element with value closest to &#39;value&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array</span><span class="o">-</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_slices"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.get_slices">[docs]</a><span class="k">def</span> <span class="nf">get_slices</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate slices in individual direction.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    size : int</span>
<span class="sd">        Size of chunk.</span>
<span class="sd">    n : int</span>
<span class="sd">        Number of chunks.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slices : list</span>
<span class="sd">        List of slices [slice(start,stop,step),...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">limits</span><span class="p">,</span> <span class="n">slices</span> <span class="o">=</span> <span class="p">([]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">limits</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">slices</span></div>


<div class="viewcode-block" id="md_header_2d"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.md_header_2d">[docs]</a><span class="k">def</span> <span class="nf">md_header_2d</span><span class="p">(</span><span class="n">hdr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get 2D header from FITS file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : path-like object or file-like object</span>
<span class="sd">        Path to FITS file to get header from.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    header_2d : :class:`~astropy.io.fits.Header`</span>
<span class="sd">        Header object without third axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="p">(</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="n">header_2d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">):</span>
        <span class="n">header_2d</span> <span class="o">=</span> <span class="n">hdr</span>
    <span class="n">keys_3d</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">,</span> <span class="s1">&#39;CRPIX3&#39;</span><span class="p">,</span> <span class="s1">&#39;CDELT3&#39;</span><span class="p">,</span> <span class="s1">&#39;CUNIT3&#39;</span><span class="p">,</span> <span class="s1">&#39;CTYPE3&#39;</span><span class="p">,</span> <span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys_3d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">header_2d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">header_2d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">header_2d</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">header_2d</span><span class="p">[</span><span class="s1">&#39;WCSAXES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">header_2d</span></div>


<div class="viewcode-block" id="save_fits"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.save_fits">[docs]</a><span class="k">def</span> <span class="nf">save_fits</span><span class="p">(</span><span class="n">filename_basis</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
              <span class="n">header</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_new&#39;</span><span class="p">,</span>
              <span class="n">path_to_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save FITS file with given filename + suffix at a given location.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename_basis : Path</span>
<span class="sd">        Path to FITS file to use as a basis for the new filename.</span>
<span class="sd">    data : numpy.ndarray</span>
<span class="sd">        Data to save under the new filename.</span>
<span class="sd">    header : :class:`~astropy.io.fits.Header`</span>
<span class="sd">        Header object that is associated with &#39;data&#39;. If None, a header of the appropriate type is created for the supplied data.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix to append to new filename. Default is &#39;_new&#39;.</span>
<span class="sd">    path_to_output : str</span>
<span class="sd">        Path to output where FITS will be saved.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional arguments are passed to :func:`astropy.io.fits.writeto()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename_basis</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">outname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">outname</span><span class="p">)</span>

    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span> <span class="n">path_to_output</span><span class="p">))</span></div>


<div class="viewcode-block" id="velocity_axes"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.velocity_axes">[docs]</a><span class="k">def</span> <span class="nf">velocity_axes</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get velocity axis from FITS file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : Path</span>
<span class="sd">        Path to FITS file to get velocity axis from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    velocity : numpy.ndarray</span>
<span class="sd">        Array of velocity axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="c1">#number of channels on spectral axis</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span> <span class="o">/</span> <span class="mi">1000</span>
    <span class="k">return</span> <span class="n">velocity</span></div>


<div class="viewcode-block" id="latitude_axes"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.latitude_axes">[docs]</a><span class="k">def</span> <span class="nf">latitude_axes</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get latitude axis from FITS file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : Path</span>
<span class="sd">        Path to FITS file to get latitude axis from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    velocity : numpy.ndarray</span>
<span class="sd">        Array of latitude axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="c1">#number of pixels along latitude axis</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="longitude_axes"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.longitude_axes">[docs]</a><span class="k">def</span> <span class="nf">longitude_axes</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get longitude axis from FITS file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : Path</span>
<span class="sd">        Path to FITS file to get longitude axis from.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    velocity : numpy.ndarray</span>
<span class="sd">        Array of longitude axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="c1">#number of pixels along longitude axis</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="world_to_pixel"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.world_to_pixel">[docs]</a><span class="k">def</span> <span class="nf">world_to_pixel</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">velocity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert world coordinates to pixel coordinates from a FITS file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : Path</span>
<span class="sd">        Path to FITS file to get coordinates from.</span>
<span class="sd">    longitude : float</span>
<span class="sd">        World coordinate value along the x-axis of the FITS file, e.g. longitude.</span>
<span class="sd">    latitude : float</span>
<span class="sd">        World coordinate value along the y-axis of the FITS file, e.g. latitude.</span>
<span class="sd">    velocity : float, optional</span>
<span class="sd">        Velocity value to convert (default is 0.).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : numpy.ndarray</span>
<span class="sd">        Returns the pixel coordinates. If the input was a single array and origin, a single array is returned, otherwise a tuple of arrays is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">velocity</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="pixel_to_world"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.pixel_to_world">[docs]</a><span class="k">def</span> <span class="nf">pixel_to_world</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                   <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ch</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert pixel coordinates to world coordinates from a FITS file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : str</span>
<span class="sd">        Path to FITS file to get coordinates from.</span>
<span class="sd">    x : float</span>
<span class="sd">        Pixel coordinate on the x-axis of the FITS file.</span>
<span class="sd">    y : float</span>
<span class="sd">        Pixel coordinate on the y-axis of the FITS file.</span>
<span class="sd">    ch : float, optional</span>
<span class="sd">        Velocity channel to convert (default is 0.).</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : numpy.ndarray</span>
<span class="sd">        Returns the world coordinates. If the input was a single array and origin, a single array is returned, otherwise a tuple of arrays is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">naxis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_spectrum"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.calculate_spectrum">[docs]</a><span class="k">def</span> <span class="nf">calculate_spectrum</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pixel_array</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate an average spectrum given a p-p-v FITS cube and pixel coordinates.</span>
<span class="sd">    If NaN values are present at specific coordinates, these coordinates will be ignored. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : Path</span>
<span class="sd">        Path to FITS file to get average spectrum from.</span>
<span class="sd">    pixel_array : List</span>
<span class="sd">        List of tuples containing pixel coordinates [(y0,x0),(y1,x1),...] over which to average.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    spectrum_average : numpy.ndarray</span>
<span class="sd">        Averaged spectrum.</span>
<span class="sd">    pixel_list_without_nan_values : List</span>
<span class="sd">        List of tuples containing pixel coordinates [(y0,x0),(y1,x1),...] at which data contain finite values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">number_of_channels</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
    <span class="n">spectrum_add</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">number_of_channels</span><span class="p">)</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">)):</span>
        <span class="n">y_1</span><span class="p">,</span><span class="n">x_1</span> <span class="o">=</span> <span class="n">pixel_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">spectrum_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span><span class="n">y_1</span><span class="p">,</span><span class="n">x_1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spectrum_i</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum_i</span><span class="p">))]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: region contains NaNs!&#39;</span><span class="p">)</span>
            <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectrum_add</span> <span class="o">=</span> <span class="n">spectrum_add</span> <span class="o">+</span> <span class="n">spectrum_i</span>
    <span class="n">spectrum_average</span> <span class="o">=</span> <span class="n">spectrum_add</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
    <span class="n">temp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pixel_list_without_nan_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">temp_array</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">spectrum_average</span><span class="p">,</span> <span class="n">pixel_list_without_nan_values</span></div>


<div class="viewcode-block" id="calculate_average_value_of_map"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.calculate_average_value_of_map">[docs]</a><span class="k">def</span> <span class="nf">calculate_average_value_of_map</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">pixel_array</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate an average value given a 2-D FITS map and pixel coordinates.</span>
<span class="sd">    If NaN values are present at specific coordinates, these coordinates will be ignored. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : path-like object or file-like object</span>
<span class="sd">        Path to FITS file to get average value from.</span>
<span class="sd">    pixel_array : list</span>
<span class="sd">        List of tuples containing pixel coordinates [(y0,x0),(y1,x1),...] over which to average.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value_average : float</span>
<span class="sd">        Averaged value.</span>
<span class="sd">    pixel_list_without_nan_values : list</span>
<span class="sd">        List of tuples containing pixel coordinates [(y0,x0),(y1,x1),...] at which data contain finite values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">value_add</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">)):</span>
        <span class="n">x_1</span><span class="p">,</span><span class="n">y_1</span> <span class="o">=</span> <span class="n">pixel_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">value_i</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">y_1</span><span class="p">,</span><span class="n">x_1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value_i</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: region contains NaNs!&#39;</span><span class="p">)</span>
            <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">n</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value_add</span> <span class="o">=</span> <span class="n">value_add</span> <span class="o">+</span> <span class="n">value_i</span>
    <span class="n">value_average</span> <span class="o">=</span> <span class="n">value_add</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
    <span class="n">temp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">pixel_array</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pixel_list_without_nan_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">temp_array</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value_average</span><span class="p">,</span> <span class="n">pixel_list_without_nan_values</span></div>


<div class="viewcode-block" id="moment_0"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.moment_0">[docs]</a><span class="k">def</span> <span class="nf">moment_0</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">velocity_end</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">noise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">path_to_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
             <span class="n">save_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">output_noise</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the zeroth moment of a p-p-v FITS cube.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : Path</span>
<span class="sd">        Path to FITS file.</span>
<span class="sd">    velocity_start : float</span>
<span class="sd">        Start velocity from which to integrate.</span>
<span class="sd">    velocity_end : float</span>
<span class="sd">        End velocity up to which data are integrated.</span>
<span class="sd">    noise : float, optional</span>
<span class="sd">        Noise value of p-p-v data. If noise is given, noise of the zeroth moment will be calculated.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where moment 0 map will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    save_file : bool</span>
<span class="sd">        Whether moment 0 map should be saved as a file. Default is True.</span>
<span class="sd">    output_noise : bool</span>
<span class="sd">        Whether moment 0 noise should be stored in a .txt file. Default is True.</span>
<span class="sd">    suffix : str</span>
<span class="sd">        Suffix of moment 0 filename.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    moment_0_map : numpy.ndarray</span>
<span class="sd">        Zeroth moment map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">getting_ready</span><span class="p">(</span><span class="s1">&#39;Computing moment 0&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">headerm0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header_save</span> <span class="o">=</span> <span class="n">md_header_2d</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity_axes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">velocity_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">velocity_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">velocity_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">velocity_start</span><span class="p">,</span><span class="n">velocity_end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">velocity_low</span> <span class="o">=</span> <span class="n">velocity_start</span>
        <span class="n">lower_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="n">velocity_low</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lower_channel</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">velocity_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">velocity_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">velocity_up</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">velocity_start</span><span class="p">,</span><span class="n">velocity_end</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">velocity_up</span> <span class="o">=</span> <span class="n">velocity_end</span>
        <span class="n">upper_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="n">velocity_up</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upper_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;channel-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">upper_channel</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;velocity-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">]))</span>
    <span class="n">moment_0_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span><span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span><span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">moment_0_map</span> <span class="o">=</span> <span class="n">moment_0_map</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,:,:]</span>
    <span class="k">elif</span> <span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span><span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">moment_0_map</span> <span class="o">=</span> <span class="n">moment_0_map</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span>
    <span class="n">moment_0_map</span> <span class="o">=</span> <span class="n">moment_0_map</span> <span class="o">*</span> <span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
    <span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.KM/S&#39;</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_mom-0_</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">05.1f</span><span class="si">}</span><span class="s1">_to_</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s1">05.1f</span><span class="si">}</span><span class="s1">km-s&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">moment_0_map</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header_save</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">newname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">num_ch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">upper_channel</span> <span class="o">-</span> <span class="n">lower_channel</span><span class="p">)</span>
        <span class="n">moment_0_noise</span> <span class="o">=</span> <span class="n">noise</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_ch</span><span class="p">)</span> <span class="o">*</span> <span class="n">headerm0</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Moment 0 noise at 1 sigma: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">moment_0_noise</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">output_noise</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">noise_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">moment_0_noise</span><span class="p">])</span>
            <span class="n">name_noise_file</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_mom-0_noise.txt&#39;</span>
            <span class="n">path_noise_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">name_noise_file</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">path_noise_file</span><span class="p">,</span> <span class="n">noise_array</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">moment_0_map</span></div>


<div class="viewcode-block" id="moment_1"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.moment_1">[docs]</a><span class="k">def</span> <span class="nf">moment_1</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
             <span class="n">velocity_start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
             <span class="n">velocity_end</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
             <span class="n">path_to_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
             <span class="n">save_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
             <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the intensity-weighted mean velocity (first moment) of a p-p-v FITS cube.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : Path</span>
<span class="sd">        Path to FITS file.</span>
<span class="sd">    velocity_start : float</span>
<span class="sd">        Start velocity from which to integrate.</span>
<span class="sd">    velocity_end : float</span>
<span class="sd">        End velocity up to which data are integrated.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where moment 1 map will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    save_file : bool</span>
<span class="sd">        Whether moment 1 map should be saved as a file. Default is True.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix of moment 1 filename.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    moment_1_map : numpy.ndarray</span>
<span class="sd">        First moment map.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">getting_ready</span><span class="p">(</span><span class="s1">&#39;Computing moment 1&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">headerm1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header_save</span> <span class="o">=</span> <span class="n">md_header_2d</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity_axes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">lower_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">)</span>
    <span class="n">upper_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">velocity_end</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;channel-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">upper_channel</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;velocity-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">]))</span>
    <span class="n">moment_1_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">headerm1</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span> <span class="n">headerm1</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">headerm1</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span> <span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">moment_1_map</span> <span class="o">=</span> <span class="n">moment_1_map</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">headerm1</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span> <span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">moment_1_map</span> <span class="o">=</span> <span class="n">moment_1_map</span> <span class="o">+</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span>
    <span class="n">moment_0_map</span> <span class="o">=</span> <span class="n">moment_0</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">,</span> <span class="n">velocity_end</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">moment_1_map</span> <span class="o">=</span> <span class="p">(</span><span class="n">moment_1_map</span> <span class="o">*</span> <span class="n">headerm1</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">moment_0_map</span>
    <span class="n">headerm1</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;KM/S&#39;</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_mom-1_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_to_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;km-s&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">moment_1_map</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header_save</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">newname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">moment_1_map</span></div>


<div class="viewcode-block" id="add_up_channels"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.add_up_channels">[docs]</a><span class="k">def</span> <span class="nf">add_up_channels</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="n">velocity_end</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="n">path_to_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                    <span class="n">save_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add up slices of a p-p-v FITS cube along the velocity axis.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : Path</span>
<span class="sd">        Path to FITS file.</span>
<span class="sd">    velocity_start : float</span>
<span class="sd">        Start velocity from which to sum up channels.</span>
<span class="sd">    velocity_end : float</span>
<span class="sd">        End velocity up to which data summed up.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where moment 1 map will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    save_file : bool, optional</span>
<span class="sd">        Whether moment 1 map should be saved as a file. Default is True.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix of moment 1 filename.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    map_sum : numpy.ndarray</span>
<span class="sd">        Map of summed up channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">getting_ready</span><span class="p">(</span><span class="s1">&#39;Adding up channels&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity_axes</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">lower_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">)</span>
    <span class="n">upper_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">velocity_end</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;channel-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">upper_channel</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;velocity-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">]))</span>
    <span class="n">map_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span> <span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">map_sum</span> <span class="o">+=</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span> <span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">map_sum</span> <span class="o">+=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_sum_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_to_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;km-s&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">map_sum</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">newname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">map_sum</span></div>


<div class="viewcode-block" id="channel_averaged"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.channel_averaged">[docs]</a><span class="k">def</span> <span class="nf">channel_averaged</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">velocity_end</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">path_to_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                     <span class="n">save_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="n">suffix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Average slices of a p-p-v FITS cube along the velocity axis.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : path-like object or file-like object</span>
<span class="sd">        Path to FITS file.</span>
<span class="sd">    velocity_start : float</span>
<span class="sd">        Start velocity from which to sum up channels.</span>
<span class="sd">    velocity_end : float</span>
<span class="sd">        End velocity up to which data summed up.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where moment 1 map will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    save_file : bool, optional</span>
<span class="sd">        Whether moment 1 map should be saved as a file. Default is True.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix of moment 1 filename.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    average_map : numpy.ndarray</span>
<span class="sd">        Map of averaged channels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">getting_ready</span><span class="p">(</span><span class="s1">&#39;Averaging channels&#39;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity_axes</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">velocity</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">lower_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">velocity_start</span><span class="p">)</span>
    <span class="n">upper_channel</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span> <span class="n">velocity_end</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;channel-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">upper_channel</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;velocity-range: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">]))</span>
    <span class="n">average_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span><span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">average_map</span> <span class="o">+=</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lower_channel</span><span class="p">,</span> <span class="n">upper_channel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">average_map</span> <span class="o">+=</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header...&#39;</span><span class="p">)</span>
    <span class="n">average_map</span> <span class="o">=</span> <span class="n">average_map</span> <span class="o">/</span> <span class="n">n</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_averaged-channel_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">lower_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;_to_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">velocity</span><span class="p">[</span><span class="n">upper_channel</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;km-s&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_file</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">average_map</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">path_to_output</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">newname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">average_map</span></div>


<div class="viewcode-block" id="pixel_circle_calculation"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.pixel_circle_calculation">[docs]</a><span class="k">def</span> <span class="nf">pixel_circle_calculation</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                             <span class="n">xcoord</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                             <span class="n">ycoord</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                             <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract both a list of pixels [(y0,x0),(y1,x1),...] and a tuple ((y0,y1,...),(x0,x1,...))</span>
<span class="sd">    corresponding to the circle region with central coordinates xcoord, ycoord, and radius r.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : Path</span>
<span class="sd">        Path to FITS file.</span>
<span class="sd">    xcoord : numpy.ndarray | float</span>
<span class="sd">        x-coordinate of central pixel in units given in the header.</span>
<span class="sd">    ycoord : numpy.ndarray | float</span>
<span class="sd">        y-coordinate of central pixel in units given in the header.</span>
<span class="sd">    r : float</span>
<span class="sd">        Radius of region in units of arcseconds.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pixel_coords : List</span>
<span class="sd">        List of pixel coordinates [(y0,x0),(y1,x1),...].</span>
<span class="sd">    indices_np : Tuple</span>
<span class="sd">        Tuple of pixel indices ((y0,y1,...),(x0,x1,...)) to index a numpy.ndarray.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span> <span class="c1">#in degree</span>
    <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">central_px</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">xcoord</span><span class="p">,</span> <span class="n">ycoord</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">central_px</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">xcoord</span><span class="p">,</span> <span class="n">ycoord</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header!&#39;</span><span class="p">)</span>
    <span class="n">central_px</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
        <span class="n">circle_size_px</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">delta</span>
        <span class="n">circle_size_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">circle_size_px</span><span class="p">))</span>
        <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
        <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">i_x</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">i_y</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">circle_size_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
                    <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_y</span><span class="p">,</span> <span class="n">i_x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="n">indices_np</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pixel_coords</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pixel_coords</span><span class="p">,</span> <span class="n">indices_np</span></div>


<div class="viewcode-block" id="pixel_circle_calculation_px"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.pixel_circle_calculation_px">[docs]</a><span class="k">def</span> <span class="nf">pixel_circle_calculation_px</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                                <span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                                <span class="n">y</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                                <span class="n">r</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract both a list of pixels [(y0,x0),(y1,x1),...] and a tuple ((y0,y1,...),(x0,x1,...))</span>
<span class="sd">    corresponding to the circle region with central pixels x, y, and radius r.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fitsfile : Path</span>
<span class="sd">        Path to FITS file.</span>
<span class="sd">    x : numpy.ndarray or float</span>
<span class="sd">        Central x pixel.</span>
<span class="sd">    y : numpy.ndarray or float</span>
<span class="sd">        Central y pixel.</span>
<span class="sd">    r : float</span>
<span class="sd">        Radius of region in units of arcseconds.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pixel_array : List</span>
<span class="sd">        List of pixel coordinates [(y0,x0),(y1,x1),...].</span>
<span class="sd">    indices_np : Tuple</span>
<span class="sd">        Tuple of pixel indices ((y0,y1,...),(x0,x1,...)) to index a numpy.ndarray.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span> <span class="c1">#in degree</span>
    <span class="n">pixel_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">central_px</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
        <span class="n">circle_size_px</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">delta</span>
        <span class="n">circle_size_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">circle_size_px</span><span class="p">))</span>
        <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">circle_size_px</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
        <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">i_x</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">i_y</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">circle_size_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
                    <span class="n">pixel_array</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_y</span><span class="p">,</span> <span class="n">i_x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pixel_array</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="n">indices_np</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pixel_array</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pixel_array</span><span class="p">,</span> <span class="n">indices_np</span></div>


<div class="viewcode-block" id="pixel_box_calculation"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.pixel_box_calculation">[docs]</a><span class="k">def</span> <span class="nf">pixel_box_calculation</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">longitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                          <span class="n">latitude</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given central coordinates, size of box, and fitsfile, return array with the corresponding pixels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    longitude : float</span>
<span class="sd">        [deg]</span>
<span class="sd">    latitude : float</span>
<span class="sd">        [deg]</span>
<span class="sd">    a,b: total size of longitude,latitude box in arcsec</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pixel_array : list</span>
<span class="sd">       List of pixel coordinates within the box [(x1,y1), (x2,y2), ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span> <span class="c1">#in degree</span>
    <span class="n">pixel_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">central_px</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">central_px</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span>
    <span class="n">central_px</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
        <span class="n">box_size_px_a</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">delta</span>
        <span class="n">box_size_px_a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">box_size_px_a</span><span class="p">))</span>
        <span class="n">box_size_px_b</span> <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">delta</span>
        <span class="n">box_size_px_b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">box_size_px_b</span><span class="p">))</span>
        <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">box_size_px_a</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">box_size_px_b</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">box_size_px_a</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">box_size_px_b</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
        <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">pixel_array</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_x</span><span class="p">,</span> <span class="n">i_y</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pixel_array</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">pixel_array</span></div>


<div class="viewcode-block" id="pixel_annulus_calculation"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.pixel_annulus_calculation">[docs]</a><span class="k">def</span> <span class="nf">pixel_annulus_calculation</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">r_in</span><span class="p">,</span> <span class="n">r_out</span><span class="p">):</span>
    <span class="c1">#longitude and latitude in degree</span>
    <span class="c1">#r_in and r_out: inner and outer radius in arcsec</span>
    <span class="c1">#give central coordinates, inner and outer radius of annulus and fitsfile and it returns array with the corresponding pixels </span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">fitsfile</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span> <span class="c1">#in degree</span>
    <span class="n">circle_in_px</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r_in</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">delta</span>
    <span class="n">circle_in_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">circle_in_px</span><span class="p">))</span>
    <span class="n">circle_out_px</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r_out</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">delta</span>
    <span class="n">circle_out_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">circle_out_px</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
        <span class="n">central_px</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span><span class="n">latitude</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">central_px</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">all_world2pix</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span><span class="n">latitude</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Something wrong with the header.&#39;</span><span class="p">)</span>
    <span class="n">central_px</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">circle_out_px</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">circle_out_px</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">circle_out_px</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">circle_out_px</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">pixel_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">i_x</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">i_y</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">circle_in_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">i_x</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">i_y</span><span class="o">-</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">circle_out_px</span><span class="o">/</span><span class="mf">2.</span><span class="p">:</span>
                <span class="n">pixel_array</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_x</span><span class="p">,</span><span class="n">i_y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pixel_array</span></div>


<span class="c1">#Calculate ellipse pixel:</span>
<span class="c1">#TODO</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">def pixel_ellipse_calculation(central_pixel_x,central_pixel_y,a_pixel,b_pixel):</span>
<span class="sd">    header = fits.getheader(fits_file)</span>
<span class="sd">    delta = -1*header[&#39;CDELT1&#39;] #in degree</span>
<span class="sd">    circle_size_px = 2*r/3600. / delta</span>
<span class="sd">    circle_size_px = int(round(circle_size_px))</span>
<span class="sd">    figure = aplpy.FITSFigure(fits_file, dimensions=[0,1], slices=[0],convention=&#39;wells&#39;)</span>
<span class="sd">    central_px = figure.world2pixel(ra,dec)</span>
<span class="sd">    central_px = [int(round(central_px[0]))-1,int(round(central_px[1]))-1]</span>
<span class="sd">    close()</span>
<span class="sd">    px_start = [central_pixel_x-2*a_pixel,central_pixel_y-2*b_pixel]    #2*a and 2*b just to be sure, that I cover the entire area</span>
<span class="sd">    px_end = [central_pixel_x+2*a_pixel,central_pixel_y+2*b_pixel]</span>
<span class="sd">    pixel_array = []</span>
<span class="sd">    print(&#39;pixel_start: &#39;+str(px_start)+&#39;   pixel_end: &#39;+str(px_end))</span>
<span class="sd">    for i_x in range(px_start[0],px_end[0]):</span>
<span class="sd">        for i_y in range(px_start[1],px_end[1]):</span>
<span class="sd">            if (((i_x-central_pixel_x)**2 / float(a_pixel)**2) + ((i_y-central_pixel_y)**2 / float(b_pixel)**2) &lt; 1 ):</span>
<span class="sd">                pixel_array.append((i_x,i_y))</span>
<span class="sd">            else:</span>
<span class="sd">                u = 1</span>
<span class="sd">    return pixel_array</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1">#Calculate ellipse pixel annulus:</span>
<div class="viewcode-block" id="pixel_ellipse_annulus_calculation"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.pixel_ellipse_annulus_calculation">[docs]</a><span class="k">def</span> <span class="nf">pixel_ellipse_annulus_calculation</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span><span class="n">center_y</span><span class="p">,</span><span class="n">x_in</span><span class="p">,</span><span class="n">x_out</span><span class="p">,</span><span class="n">y_in</span><span class="p">,</span><span class="n">y_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract both a list of pixels [(y0,x0),(y1,x1),...,(yn,xn)] and a tuple ((y0,y1,...,yn),(x0,x1,...,xn))</span>
<span class="sd">    corresponding to the ellipse annulus region with central coordinates center_x, center_y,</span>
<span class="sd">    and inner and outer semimajor/semiminor axes x_in, x_out/ y_in, y_out (or the other way around).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    center_x : int</span>
<span class="sd">        x-coordinate of central pixel in pixel units.</span>
<span class="sd">    center_y : int</span>
<span class="sd">        y-coordinate of central pixel in pixel units.</span>
<span class="sd">    x_in : int</span>
<span class="sd">        inner semimajor/minor axis of region along x-axis in pixel units.</span>
<span class="sd">    x_out : int</span>
<span class="sd">    	outer semimajor/minor axis of region along x-axis in pixel units.</span>
<span class="sd">    y_in : int</span>
<span class="sd">    	inner semimajor/minor axis of region along y-axis in pixel units.</span>
<span class="sd">    y_out : int</span>
<span class="sd">    	outer semimajor/minor axis of region along y-axis in pixel units.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pixel_coords : list</span>
<span class="sd">        List of pixel coordinates [(y0,x0),(y1,x1),...,(yn,xn)].</span>
<span class="sd">    indices_np : tuple</span>
<span class="sd">        Tuple of pixel indices ((y0,y1,...,yn),(x0,x1,...,xn)) to index a numpy.ndarray.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">central_px</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">center_y</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))]</span>
    <span class="n">px_start</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_out</span><span class="p">,</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_out</span><span class="p">]</span>
    <span class="n">px_end</span> <span class="o">=</span> <span class="p">[</span><span class="n">central_px</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">x_out</span><span class="p">,</span><span class="n">central_px</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">y_out</span><span class="p">]</span>
    <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">x_in</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">y_in</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">i_x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_out</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">i_y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_out</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_y</span><span class="p">,</span><span class="n">i_x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i_x</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i_y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px_end</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">i_x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_out</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">i_y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_out</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(((</span><span class="n">i_x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">x_in</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">((</span><span class="n">i_y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">y_in</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i_y</span><span class="p">,</span><span class="n">i_x</span><span class="p">))</span>
    <span class="n">indices_np</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pixel_coords</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pixel_coords</span><span class="p">,</span> <span class="n">indices_np</span></div>


<div class="viewcode-block" id="get_off_diagonal"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.get_off_diagonal">[docs]</a><span class="k">def</span> <span class="nf">get_off_diagonal</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract both a list of pixel coordinate tuples [(y0,x0),(y1,x1),...,(yn,xn)] and a tuple ((y0,y1,...,yn),(x0,x1,...,xn))</span>
<span class="sd">    corresponding to off diagonal elements of a 2D numpy.ndarray</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of file.</span>
<span class="sd">    offset : int</span>
<span class="sd">        y-axis offset from diagonal in units of pixels.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pixel_coords : list</span>
<span class="sd">        List of pixel coordinates [(y0,x0),(y1,x1),...,(yn,xn)].</span>
<span class="sd">    indices_np : tuple</span>
<span class="sd">        Tuple of pixel indices ((y0,y1,...,yn),(x0,x1,...,xn)) to index a numpy.ndarray.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">xsize</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ysize</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ysize</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">xsize</span><span class="p">)</span>
    <span class="n">pixel_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xsize</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ysize</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">offset</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">offset</span><span class="p">:</span>
                <span class="n">pixel_coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
    <span class="n">indices_np</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pixel_coords</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pixel_coords</span><span class="p">,</span> <span class="n">indices_np</span></div>


<div class="viewcode-block" id="make_subcube"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.make_subcube">[docs]</a><span class="k">def</span> <span class="nf">make_subcube</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">cubedata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">longitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">latitudes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">velo_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path_to_output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">return_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_file</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a subcube from an existing SpectralCube (or 2D Projection) given some coordinate ranges.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to file to create a subcube from.</span>
<span class="sd">    cubedata : None or :class:`~spectralcube.SpectralCube` or :class:`~spectralcube.Projection`, optional</span>
<span class="sd">        SpectralCube of data if data is already read in. This option avoids reading data into memory again.</span>
<span class="sd">    longitudes : list</span>
<span class="sd">        List of coordinate range of first world coordinate axis.</span>
<span class="sd">    latitudes : list</span>
<span class="sd">        List of coordinate range of second world coordinate axis.</span>
<span class="sd">    velo_range : list</span>
<span class="sd">        List of velocity range of spectral coordinate axis.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where subcube will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix that is appended to output filename.</span>
<span class="sd">    return_data : bool, optional</span>
<span class="sd">        Option to return data of the subcube. Default is False.</span>
<span class="sd">    save_file : bool, optional</span>
<span class="sd">        Whether subcube should be saved as a file. Default is True.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Option to print subcube info and save messages. Default is True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">getting_ready</span><span class="p">(</span><span class="s1">&#39;Making subcube&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cubedata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>  <span class="c1"># Open the FITS file for reading</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Initiate a SpectralCube</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the FITS file - we already read it in and don&#39;t need it anymore!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">cubedata</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>

    <span class="c1"># extract coordinates</span>
    <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1">#extract world coordinates from cube</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1">#extract world coordinates from cube</span>
        <span class="n">v</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">world</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1">#extract velocity world coordinates from cube</span>
    <span class="k">elif</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">world</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1">#extract world coordinates from 2d image</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1">#extract world coordinates from 2d image</span>

    <span class="c1"># Define desired coordinate range</span>
    <span class="n">physical_types</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">world_axis_physical_types</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Make sure to give coordinates in the frame of the data header: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">physical_types</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">latitudes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lat_range</span> <span class="o">=</span> <span class="n">latitudes</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">lat_range_idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">lat_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="c1">#lat_range_idx[-1] = lat_range_idx[-1] + 1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lat_range_idx</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">longitudes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lon_range</span> <span class="o">=</span> <span class="n">longitudes</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">lon_range_idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">lon_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="c1">#lon_range_idx[-1] = lon_range_idx[-1] + 1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lon_range_idx</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
	
    <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">velo_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vel_range</span> <span class="o">=</span> <span class="n">velo_range</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
            <span class="n">vel_range_idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vel_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vel_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
            <span class="c1">#vel_range_idx[-1] = vel_range_idx[-1] + 1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vel_range_idx</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vel_range_idx</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lat_range_idx</span><span class="o">+</span><span class="n">lon_range_idx</span><span class="o">+</span><span class="n">vel_range_idx</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Have to specify coordinate ranges!&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create a sub_cube cut to these coordinates</span>
    <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">sub_cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[</span><span class="n">vel_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">vel_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lat_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">lat_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lon_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">lon_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">cube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">sub_cube</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[</span><span class="n">lat_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">lat_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">lon_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">lon_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sub_cube</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
        <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_subcube&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>
        <span class="n">sub_cube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">return_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sub_cube</span></div>


<div class="viewcode-block" id="make_lv"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.make_lv">[docs]</a><span class="k">def</span> <span class="nf">make_lv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path_to_output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a longitude-velocity map from a datacube.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to file to create a longitude-velocity map from.</span>
<span class="sd">    mode : str</span>
<span class="sd">        \b</span>
<span class="sd">        Mode to compute the value of collapsed latitude axis.</span>
<span class="sd">        `&#39;avg&#39;` is the arithmetic mean along the latitude axis.</span>
<span class="sd">        `&#39;max&#39;` gives the maximum value along the latitude axis.</span>
<span class="sd">        `&#39;sum&#39;` gives thes sum along the latitude axis.</span>
<span class="sd">        `&#39;weighted&#39;` gives a weighted arithmetic mean along the latitude axis.</span>
<span class="sd">    weights : str, optional</span>
<span class="sd">        Path to file containing weights. Needs to be of same shape as data of filename.</span>
<span class="sd">    noise : float</span>
<span class="sd">        Noise to use as a threshold. Every pixel value below the noise will be masked.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where subcube will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix that is appended to output filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">getting_ready</span><span class="p">(</span><span class="s1">&#39;Making l-v map&#39;</span><span class="p">)</span>
    <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;avg&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;weighted&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown mode. Mode needs to be one of the following: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">No weights have been given! Will compute arithmetic mean with equal weights instead.&quot;</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">weight</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Shape of weights need to be equal to shape of data!&quot;</span><span class="p">)</span>
    
    <span class="n">pv_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">],</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]))</span>
    <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wcs</span> <span class="o">=</span> <span class="n">sanitize_wcs</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>
    <span class="n">wcs_slice</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">sub</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">WCSSUB_SPECTRAL</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Set spatial parameters</span>
    <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span>
    <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span>
    <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">ctype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GLON&#39;</span>
    <span class="n">wcs_slice</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cunit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span>

    <span class="n">new_header</span> <span class="o">=</span> <span class="n">wcs_slice</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
    <span class="n">new_header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span>
    <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span>
    <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span>
    <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span>
    <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span>
    <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;avg&#39;</span><span class="p">:</span>
        <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Avg. brightness (pixel) unit&#39;</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Maximum brightness (pixel) unit&#39;</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Sum of brightness pixels&#39;</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
        <span class="n">new_header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Weighted mean of brightness (pixel) unit&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noisemask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">noise</span><span class="p">)</span>
        <span class="n">weight</span><span class="p">[</span><span class="n">noisemask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">data</span><span class="p">[</span><span class="n">noisemask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">for</span> <span class="n">vel</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;avg&#39;</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vel</span><span class="p">,:,</span><span class="n">lon</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vel</span><span class="p">,:,</span><span class="n">lon</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">vel</span><span class="p">,:,</span><span class="n">lon</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;weighted&#39;</span><span class="p">:</span>
                <span class="n">norm_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">vel</span><span class="p">,:,</span><span class="n">lon</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">vel</span><span class="p">,:,</span><span class="n">lon</span><span class="p">]))</span>
                <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">norm_weight</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">vel</span><span class="p">,:,</span><span class="n">lon</span><span class="p">])</span>
            <span class="n">pv_array</span><span class="p">[</span><span class="n">vel</span><span class="p">,</span><span class="n">lon</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">mode_suffix</span> <span class="o">=</span> <span class="s1">&#39;_longitude_velocity_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="n">mode_suffix</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">pv_array</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">new_header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span></div>


<div class="viewcode-block" id="jansky_to_kelvin"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.jansky_to_kelvin">[docs]</a><span class="k">def</span> <span class="nf">jansky_to_kelvin</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span><span class="n">theta_1</span><span class="p">,</span><span class="n">theta_2</span><span class="p">):</span> <span class="c1">#in units of (GHz,arcsec,arcsec)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">k_B</span>
    <span class="n">theta_1</span> <span class="o">=</span> <span class="n">theta_1</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">360.</span><span class="o">/</span><span class="mf">3600.</span>
    <span class="n">theta_2</span> <span class="o">=</span> <span class="n">theta_2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">360.</span><span class="o">/</span><span class="mf">3600.</span>
    <span class="n">S</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">frequency</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">26</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta_1</span><span class="o">*</span> <span class="n">theta_2</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">S</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Jy/K = </span><span class="si">{:.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;K/Jy = </span><span class="si">{:.5e}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span></div>


<div class="viewcode-block" id="convert_jybeam_to_kelvin"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.convert_jybeam_to_kelvin">[docs]</a><span class="k">def</span> <span class="nf">convert_jybeam_to_kelvin</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">path_to_output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="c1"># Open the FITS file for reading</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Initiate a SpectralCube</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># as a fallback if fits is a 2d image</span>
    <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># Close the FITS file - we already read it in and don&#39;t need it anymore!</span>

    <span class="n">cube</span><span class="o">.</span><span class="n">allow_huge_operations</span><span class="o">=</span><span class="kc">True</span>
    <span class="n">cube</span><span class="o">.</span><span class="n">unit</span>  

    <span class="n">kcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>  
    <span class="n">kcube</span><span class="o">.</span><span class="n">unit</span> 
    
    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_unit_Tb&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>
    <span class="n">kcube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span></div>


<div class="viewcode-block" id="convert_jtok_huge_dataset"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.convert_jtok_huge_dataset">[docs]</a><span class="k">def</span> <span class="nf">convert_jtok_huge_dataset</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_unit_Tb&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="c1"># Open the FITS file for reading</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># Initiate a SpectralCube</span>
        <span class="n">jtok_factors</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">beam</span><span class="o">.</span><span class="n">jtok</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">with_spectral_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">GHz</span><span class="p">)</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>
        <span class="n">outfh</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
    
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">jtok_factors</span><span class="p">))</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,(</span><span class="nb">slice</span><span class="p">,</span><span class="n">factor</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">jtok_factors</span><span class="p">)):</span>
                <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span> <span class="o">*</span> <span class="n">factor</span>
                <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span> <span class="c1"># write the data to disk</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;K&#39;</span>
        <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># as a fallback if fits is a 2d image</span>
        <span class="n">kcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
        <span class="n">kcube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="find_common_beam"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.find_common_beam">[docs]</a><span class="k">def</span> <span class="nf">find_common_beam</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filenames</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;&#39;filenames&#39; needs to be a list of len=2&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;filenames&#39; needs to be a list of len=2&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube1</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube1</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube2</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube2</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filenames</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">common_beam</span> <span class="o">=</span> <span class="n">radio_beam</span><span class="o">.</span><span class="n">commonbeam</span><span class="o">.</span><span class="n">common_2beams</span><span class="p">(</span><span class="n">radio_beam</span><span class="o">.</span><span class="n">Beams</span><span class="p">(</span><span class="n">beams</span><span class="o">=</span><span class="p">[</span><span class="n">cube1</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">cube2</span><span class="o">.</span><span class="n">beam</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">common_beam</span></div>


<div class="viewcode-block" id="spatial_smooth"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.spatial_smooth">[docs]</a><span class="k">def</span> <span class="nf">spatial_smooth</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">beam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path_to_output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_huge_operations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Smooth an image or cube channel by channel with a 2D Gaussian.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to file to smooth.</span>
<span class="sd">    beam : `~radio_beam.Beam &lt;https://radio-beam.readthedocs.io/en/latest/api/radio_beam.Beam.html#radio_beam.Beam&gt;`__</span>
<span class="sd">        Beam of the target resolution.</span>
<span class="sd">    major : float</span>
<span class="sd">        The FWHM major axis in units of [arcsec]. Has to be specified if no `beam` is given.</span>
<span class="sd">    minor : float</span>
<span class="sd">        The FWHM minor axis in units of [arcsec]. If not specified, will be assumed to be equal to `major`.</span>
<span class="sd">    pa : float</span>
<span class="sd">        The beam position angle.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where smoothed file will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix that is appended to output filename.</span>
<span class="sd">    allow_huge_operations : bool, optional</span>
<span class="sd">        Option to read in files of size &gt;1gb. Default is False.</span>
<span class="sd">    datatype : str, optional</span>
<span class="sd">        Allows the user to perform smoothing on whole file at once (`&#39;regular&#39;`) or to write file channel by channel (`&#39;large&#39;`). Default is &#39;regular&#39;.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments are passed to :meth:`spectral_cube.SpectralCube.convolve_to()` and the convolution function :meth:`astropy.convolution.convolve()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">beam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">major</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">minor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need to specify beam size if no beam is given.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No minor beam size was given, will assume major=minor&#39;</span><span class="p">)</span>
        <span class="n">beam</span> <span class="o">=</span> <span class="n">radio_beam</span><span class="o">.</span><span class="n">Beam</span><span class="p">(</span><span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="n">pa</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">beam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam</span> <span class="o">=</span> <span class="n">beam</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">major</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">beam</span><span class="o">.</span><span class="n">minor</span>
    <span class="n">meanbeam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">major</span><span class="o">*</span><span class="n">minor</span><span class="p">)</span> <span class="c1"># geometric mean</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_smooth_</span><span class="si">{</span><span class="n">meanbeam</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">meanbeam</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allow_huge_operations</span><span class="p">:</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">allow_huge_operations</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;large&#39;</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pathname</span><span class="p">)</span>
        <span class="n">outfh</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">smooth_slice</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">convolve_to</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="c1"># still reads in copy of cube to store convolution; should be fixed</span>
                <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_slice</span><span class="o">.</span><span class="n">array</span>
                <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span> <span class="c1"># write the data to disk</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">beam</span><span class="o">.</span><span class="n">to_header_keywords</span><span class="p">())</span>
        <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;BEAM&#39;</span> <span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Beam: BMAJ=</span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">major</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> arcsec BMIN=</span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">minor</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> arcsec BPA=</span><span class="si">{</span><span class="n">beam</span><span class="o">.</span><span class="n">pa</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> deg&#39;</span><span class="p">})</span>
        <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">smoothcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">convolve_to</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">smoothcube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span></div>


<div class="viewcode-block" id="spectral_smooth"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.spectral_smooth">[docs]</a><span class="k">def</span> <span class="nf">spectral_smooth</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path_to_output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_huge_operations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Smooth a cube spectrally.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to file to smooth.</span>
<span class="sd">    factor : float</span>
<span class="sd">        Factor by which to smooth the spectra. Will be used if no `target_resolution` is given.</span>
<span class="sd">    target_resolution : `~astropy.units.Quantity &lt;https://docs.astropy.org/en/stable/api/astropy.units.Quantity.html#astropy.units.Quantity&gt;`__</span>
<span class="sd">        Target resolution of spectrally smoothed data.</span>
<span class="sd">    path_to_output : str, optional</span>
<span class="sd">        Path to output where smoothed file will be saved. By default, the subcube will be saved in the working directory.</span>
<span class="sd">    suffix : str, optional</span>
<span class="sd">        Suffix that is appended to output filename.</span>
<span class="sd">    allow_huge_operations : bool, optional</span>
<span class="sd">        Option to read in files of size &gt;1gb. Default is False.</span>
<span class="sd">    datatype : str, optional</span>
<span class="sd">        Allows the user to perform smoothing on whole file at once (`&#39;regular&#39;`) or to write file channel by channel (`&#39;large&#39;`). Default is &#39;regular&#39;.</span>
<span class="sd">    chunks : int</span>
<span class="sd">        Number of chunks data will be divided into if `datatype=&#39;large&#39;`. Default is 20.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments are passed to :meth:`spectral_cube.SpectralCube.spectral_smooth()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not open file as SpectralCube. Check the dimensions.&quot;</span><span class="p">)</span>

    <span class="n">fwhm_to_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">velocity_res_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Have to specify either `factor` or `target_resolution`.&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">velocity_res_1</span>
        <span class="n">spectral_smoothing_kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="n">factor</span><span class="o">/</span><span class="n">fwhm_to_sigma</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">target_resolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target_resolution</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>
        <span class="n">fwhm_gaussian</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">velocity_res_1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">spectral_smoothing_kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="n">fwhm_gaussian</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">fwhm_to_sigma</span><span class="p">)</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_spectral_smooth_</span><span class="si">{</span><span class="n">target</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">kms&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">allow_huge_operations</span><span class="p">:</span>
        <span class="n">cube</span><span class="o">.</span><span class="n">allow_huge_operations</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;large&#39;</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pathname</span><span class="p">)</span>
        <span class="n">outfh</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span>
        <span class="n">x_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">chunks</span><span class="p">)</span>
        <span class="n">x_slices</span> <span class="o">=</span> <span class="n">get_slices</span><span class="p">(</span><span class="n">x_size</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x_slices</span><span class="p">))</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x_slice</span> <span class="ow">in</span> <span class="n">x_slices</span><span class="p">:</span>
                <span class="n">smooth_slice</span> <span class="o">=</span> <span class="n">cube</span><span class="p">[:,:,</span><span class="n">x_slice</span><span class="p">]</span><span class="o">.</span><span class="n">spectral_smooth</span><span class="p">(</span><span class="n">spectral_smoothing_kernel</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[:,:,</span><span class="n">x_slice</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_slice</span><span class="o">.</span><span class="n">unmasked_data</span><span class="p">[:]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span> <span class="c1"># write the data to disk</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#CDELT (SAMPLING) IS STILL THE SAME; BUT RESOLUTION CHANGED</span>
        <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Channel width but spectral res. is &#39;</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">smoothcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">spectral_smooth</span><span class="p">(</span><span class="n">spectral_smoothing_kernel</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">smoothcube</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span></div>

	
<div class="viewcode-block" id="reproject_cube"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.reproject_cube">[docs]</a><span class="k">def</span> <span class="nf">reproject_cube</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span> <span class="n">path_to_output</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_huge_operations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube1</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube1</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>	
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cube2</span> <span class="o">=</span> <span class="n">SpectralCube</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cube2</span> <span class="o">=</span> <span class="n">Projection</span><span class="o">.</span><span class="n">from_hdu</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">template</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">axes</span><span class="o">==</span><span class="s1">&#39;spatial&#39;</span><span class="p">:</span>
        <span class="n">header_template</span> <span class="o">=</span> <span class="n">cube2</span><span class="o">.</span><span class="n">header</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS3&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;WCSAXES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WCSAXES&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRPIX3&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT3&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CUNIT3&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CTYPE3&#39;</span><span class="p">]</span>
        <span class="n">header_template</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CRVAL3&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">axes</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">header_template</span> <span class="o">=</span> <span class="n">cube2</span><span class="o">.</span><span class="n">header</span>

    <span class="n">filename_wext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">filename_base</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_wext</span><span class="p">)</span>
    <span class="n">newname</span> <span class="o">=</span> <span class="n">filename_base</span> <span class="o">+</span> <span class="s1">&#39;_reproject&#39;</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span>
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_output</span><span class="p">,</span> <span class="n">newname</span><span class="p">)</span>

    <span class="c1">#TODO</span>
    <span class="k">if</span> <span class="n">allow_huge_operations</span><span class="p">:</span>
        <span class="n">cube1</span><span class="o">.</span><span class="n">allow_huge_operations</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">datatype</span><span class="o">==</span><span class="s1">&#39;large&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">axes</span><span class="o">==</span><span class="s1">&#39;spatial&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">pathname</span><span class="p">)</span>
            <span class="n">outfh</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
            <span class="n">header_template</span> <span class="o">=</span> <span class="n">md_header_2d</span><span class="p">(</span><span class="n">header_template</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">cube2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">cube_slice_reproj</span> <span class="o">=</span> <span class="n">cube1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">header_template</span><span class="p">)</span>
                    <span class="n">outfh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cube_slice_reproj</span><span class="o">.</span><span class="n">array</span>
                    <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span> <span class="c1"># write the data to disk</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outfh</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cube1_reproj</span> <span class="o">=</span> <span class="n">cube1</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="n">header_template</span><span class="p">)</span>

        <span class="n">cube1_reproj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\033</span><span class="s2">[92mSAVED FILE:</span><span class="se">\033</span><span class="s2">[0m &#39;</span><span class="si">{}</span><span class="s2">&#39; in &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span><span class="n">path_to_output</span><span class="p">))</span></div>


<span class="c1">#TODO</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">subcube_from_region using spectral cube</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="smooth_1d"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.smooth_1d">[docs]</a><span class="k">def</span> <span class="nf">smooth_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">window_len</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span><span class="n">window</span><span class="o">=</span><span class="s1">&#39;hanning&#39;</span><span class="p">):</span> <span class="c1"># smooth spectrum</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;smooth the data using a window with requested size.</span>
<span class="sd">    input:</span>
<span class="sd">        x: the input signal </span>
<span class="sd">        window_len: the dimension of the smoothing window; should be an odd integer</span>
<span class="sd">        window: the type of window from &#39;flat&#39;, &#39;hanning&#39;, &#39;hamming&#39;, &#39;bartlett&#39;, &#39;blackman&#39;</span>
<span class="sd">            flat window will produce a moving average smoothing.</span>
<span class="sd">    output:</span>
<span class="sd">        the smoothed signal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;smooth only accepts 1 dimension arrays.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">window_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input vector needs to be bigger than window size.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">window_len</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="s1">&#39;hanning&#39;</span><span class="p">,</span> <span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="s1">&#39;bartlett&#39;</span><span class="p">,</span> <span class="s1">&#39;blackman&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Window is on of &#39;flat&#39;, &#39;hanning&#39;, &#39;hamming&#39;, &#39;bartlett&#39;, &#39;blackman&#39;&quot;</span><span class="p">)</span>

    <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">window_len</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="c1">#print(len(s))</span>
    <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">:</span> <span class="c1">#moving average</span>
        <span class="n">w</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_len</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;numpy.&#39;</span><span class="o">+</span><span class="n">window</span><span class="o">+</span><span class="s1">&#39;(window_len)&#39;</span><span class="p">)</span>

    <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">s</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span><span class="p">[(</span><span class="nb">round</span><span class="p">(</span><span class="n">window_len</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span><span class="o">-</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">window_len</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span></div>


<div class="viewcode-block" id="rebin"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.rebin">[docs]</a><span class="k">def</span> <span class="nf">rebin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">newshape</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Rebin an array to a new shape.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>

    <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">old</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">old</span><span class="p">)</span><span class="o">/</span><span class="n">new</span><span class="p">)</span> <span class="k">for</span> <span class="n">old</span><span class="p">,</span><span class="n">new</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">newshape</span><span class="p">)]</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">slices</span><span class="p">]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span> <span class="c1">#choose the biggest smaller integer index</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)]</span></div>


<span class="c1">#smooth spectrum by averaging adjacent channels</span>
<div class="viewcode-block" id="smooth_ave"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.smooth_ave">[docs]</a><span class="k">def</span> <span class="nf">smooth_ave</span><span class="p">(</span><span class="n">spectrum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;spectrum has to be of shape (N, 2)&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="n">spectrum</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#pad with edge_values at the end if odd number of channels</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="n">spectrum</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Array needs to be of shape (N, 2) but instead has shape </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Array needs to be 2-D.&#39;</span><span class="p">)</span></div>

	
<span class="c1">#this works only once since values are repeated to keep the same shape</span>
<div class="viewcode-block" id="smooth_2"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.smooth_2">[docs]</a><span class="k">def</span> <span class="nf">smooth_2</span><span class="p">(</span><span class="n">spectrum</span><span class="p">):</span>
    <span class="n">new_spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="mi">2</span> <span class="o">-</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">size</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">repeats</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#pad with edge_values at the end if odd number of channels</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">size</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_spectrum</span>
    <span class="k">elif</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">size</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_spectrum</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Something wrong with dimensions of array.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="calculate_pixelArray_along_filament"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.calculate_pixelArray_along_filament">[docs]</a><span class="k">def</span> <span class="nf">calculate_pixelArray_along_filament</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">filamentdata</span><span class="p">,</span><span class="n">halfwidth_pc</span><span class="p">,</span><span class="n">distance_of_source</span><span class="p">):</span>
    <span class="c1">#filamentdata in px coordinates ; halfwidth_pc and distance in unit pc</span>
    <span class="c1">#find the tangent curve</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">pixel_scale</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span> <span class="o">*</span> <span class="n">distance_of_source</span> <span class="c1">#pc per px</span>
    <span class="n">halfwidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">halfwidth_pc</span> <span class="o">/</span> <span class="n">pixel_scale</span><span class="p">,</span><span class="n">decimals</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">filament_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filamentdata</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">filament_coords</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">filament_coords</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">filament_coords</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">pixel_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">filament_coords</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        
        <span class="n">line_perpList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line_perpList2</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="c1"># point on the filament</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#print a, b	</span>
        <span class="c1">#plt.plot(normal)</span>
        <span class="c1">#equation of normal plane: ax+by=const</span>

        <span class="n">const</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normal</span><span class="o">*</span><span class="n">r0</span><span class="p">)</span>
					
        <span class="c1"># defining lists an array to be used below</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
            <span class="n">distance2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>

            <span class="n">line_perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="c1">#</span>
            <span class="n">line_perp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="c1">#</span>
        <span class="k">elif</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">distance2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">line_perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#</span>
            <span class="n">line_perp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;FITS file must be 2D or 3D. Instead, file has shape </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intensity</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>		
			
		
        <span class="c1"># Loop 1: if the slope is negative</span>
        <span class="k">if</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">npix</span> <span class="o">=</span> <span class="n">halfwidth</span>
            <span class="c1">#print(distance.shape)</span>
            <span class="k">if</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">npix</span>
                <span class="c1">#print(&#39;npix unmodified: &#39;, npix)</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">x0</span>
                <span class="c1">#print(&#39;npix modified: &#39;, npix)</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">y0</span>
                <span class="c1">#print(&#39;npix modified: &#39;, npix)</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix_x</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">x0</span>
                <span class="n">npix_y</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">y0</span>
                <span class="k">if</span> <span class="n">npix_x</span> <span class="o">&lt;</span> <span class="n">npix_y</span><span class="p">:</span>
                    <span class="n">npix</span> <span class="o">=</span> <span class="n">npix_x</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">npix</span> <span class="o">=</span> <span class="n">npix_y</span>
				
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">npix</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">npix</span><span class="p">,</span><span class="n">x0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
			
                    <span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">jj</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1">#distance between point (i,j) and filament</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">npix</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">dist_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">ii</span><span class="o">-</span><span class="n">const</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="c1">#distance between point (i,j) and the normal </span>
                        <span class="c1">#take the point if it is in the vicinity of the normal (distance &lt; 2 pix)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">dist_normal</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">line_perp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="c1">#storing the nearby points</span>
                            <span class="n">line_perpList</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]))</span>



            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="n">npix</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x0</span><span class="o">+</span><span class="n">npix</span><span class="p">):</span>
	     
                    <span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">jj</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">npix</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">dist_normal2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">ii</span><span class="o">-</span><span class="n">const</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normal</span><span class="o">*</span><span class="n">normal</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> 
							
                        <span class="k">if</span> <span class="p">(</span><span class="n">dist_normal2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span> 
                            <span class="n">line_perp2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> 
                            <span class="n">line_perpList2</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]))</span>			
							
	
        <span class="c1">#Loop 2_ if the slope is positive</span>
        <span class="k">elif</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">npix</span> <span class="o">=</span> <span class="n">halfwidth</span>
				
				
            <span class="k">if</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">npix</span>
                <span class="c1">#print(&#39;npix unmodified: &#39;, npix)</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">x0</span>
                <span class="c1">#print(&#39;npix modified: &#39;, npix)</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&lt;</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">y0</span>
                <span class="c1">#print(&#39;npix modified: &#39;, npix)</span>
            <span class="k">elif</span> <span class="n">y0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span> <span class="o">&gt;=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">npix_x</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">x0</span>
                <span class="n">npix_y</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span> <span class="n">y0</span>
                <span class="k">if</span> <span class="n">npix_x</span> <span class="o">&lt;</span> <span class="n">npix_y</span><span class="p">:</span>
                    <span class="n">npix</span> <span class="o">=</span> <span class="n">npix_x</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">npix</span> <span class="o">=</span> <span class="n">npix_y</span>
                <span class="c1">#print(&#39;npix modified: &#39;, npix)	</span>
			
	
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="n">npix</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x0</span><span class="o">-</span><span class="n">npix</span><span class="p">,</span><span class="n">x0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">jj</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">npix</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">dist_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">ii</span><span class="o">-</span><span class="n">const</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normal</span><span class="o">*</span><span class="n">normal</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">dist_normal</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">line_perp</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span>
                            <span class="n">line_perpList</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">distance</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]))</span>


            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">y0</span><span class="o">-</span><span class="n">npix</span><span class="p">,</span><span class="n">y0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x0</span><span class="o">+</span><span class="n">npix</span><span class="p">):</span>
                    <span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">jj</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">&lt;</span>  <span class="n">npix</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">dist_normal2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">jj</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">ii</span><span class="o">-</span><span class="n">const</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normal</span><span class="o">*</span><span class="n">normal</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">dist_normal2</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">line_perp2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]</span>
                            <span class="n">line_perpList2</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">distance2</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">]))</span>

        <span class="n">perpendicularLine</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line_perpList</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">perpendicularLine2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line_perpList2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">total_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">perpendicularLine2</span><span class="p">,</span><span class="n">perpendicularLine</span><span class="p">))</span>
    
        <span class="n">pixel_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_array</span><span class="p">)</span>
        <span class="n">pixel_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixel_list</span><span class="p">)</span> 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Filament positions selected over &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">halfwidth_pc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; pc slices perpendicular to filament&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pixel_array</span></div>


<span class="c1">#WORLD COORDS, adapted from filchap (Suri 2018)</span>
<div class="viewcode-block" id="calculateLength_worldcoords"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.calculateLength_worldcoords">[docs]</a><span class="k">def</span> <span class="nf">calculateLength_worldcoords</span><span class="p">(</span><span class="n">filamentDatafile</span><span class="p">,</span><span class="n">distance</span><span class="p">):</span>
    <span class="c1">#distance in pc</span>
    <span class="n">filamentData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filamentDatafile</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filamentData</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x_1</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_1</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_2</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_2</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">delta_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_2</span> <span class="o">-</span> <span class="n">x_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">delta_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_2</span> <span class="o">-</span> <span class="n">y_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta_x</span> <span class="o">+</span> <span class="n">delta_y</span><span class="p">)</span>	
        <span class="n">theta</span> <span class="o">=</span> <span class="n">delta</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span> <span class="c1">#convert degree to radians.</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">distance</span>		
        <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">R</span>	
    <span class="k">return</span> <span class="n">length</span></div>

<span class="c1">###ORIGINAL script, pixel coords</span>
<div class="viewcode-block" id="calculateLength"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.calculateLength">[docs]</a><span class="k">def</span> <span class="nf">calculateLength</span><span class="p">(</span><span class="n">filamentDatafile</span><span class="p">,</span><span class="n">distance</span><span class="p">,</span><span class="n">pix_size</span><span class="p">):</span>
    <span class="c1">#px size in arcsec per px, distance in pc</span>
    <span class="n">filamentData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filamentDatafile</span><span class="p">)</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filamentData</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x_1</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_1</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_2</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_2</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">delta_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_2</span> <span class="o">-</span> <span class="n">x_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">delta_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_2</span> <span class="o">-</span> <span class="n">y_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta_x</span> <span class="o">+</span> <span class="n">delta_y</span><span class="p">)</span>	
        <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="n">pix_size</span><span class="p">)</span><span class="o">/</span><span class="mi">206265</span> <span class="c1">#convert arcsec to radians.</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">distance</span>		
        <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">R</span>	
    <span class="k">return</span> <span class="n">length</span></div>

<span class="c1">#with file already read in</span>
<div class="viewcode-block" id="calculateLength_from_array"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.calculateLength_from_array">[docs]</a><span class="k">def</span> <span class="nf">calculateLength_from_array</span><span class="p">(</span><span class="n">filamentData</span><span class="p">,</span><span class="n">distance</span><span class="p">,</span><span class="n">pix_size</span><span class="p">):</span>
    <span class="c1">#px size in arcsec per px, distance in pc</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filamentData</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">x_1</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_1</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">x_2</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_2</span> <span class="o">=</span> <span class="n">filamentData</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">delta_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_2</span> <span class="o">-</span> <span class="n">x_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">delta_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_2</span> <span class="o">-</span> <span class="n">y_1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">delta_x</span> <span class="o">+</span> <span class="n">delta_y</span><span class="p">)</span>	
        <span class="n">theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="n">pix_size</span><span class="p">)</span><span class="o">/</span><span class="mi">206265</span> <span class="c1">#convert arcsec to radians.</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">distance</span>		
        <span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">R</span>	
    <span class="k">return</span> <span class="n">length</span></div>


<div class="viewcode-block" id="estimate_cont_noise"><a class="viewcode-back" href="../../astrojoni_tools.html#astrojoni_tools.functions.estimate_cont_noise">[docs]</a><span class="k">def</span> <span class="nf">estimate_cont_noise</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inner_pct</span><span class="p">,</span> <span class="n">outer_pct</span><span class="p">):</span>
    <span class="c1">#global inner_pct, outer_pct</span>
    <span class="n">y_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">central_px_x</span> <span class="o">=</span> <span class="n">x_size</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">central_px_y</span> <span class="o">=</span> <span class="n">y_size</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">px_array</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">pixel_ellipse_annulus_calculation</span><span class="p">(</span><span class="n">central_px_x</span><span class="p">,</span> <span class="n">central_px_y</span><span class="p">,</span> <span class="n">inner_pct</span><span class="o">*</span><span class="n">x_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">outer_pct</span><span class="o">*</span><span class="n">x_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">inner_pct</span><span class="o">*</span><span class="n">y_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">outer_pct</span><span class="o">*</span><span class="n">y_size</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>

    <span class="c1"># only select data within that annulus region</span>
    <span class="n">data_in_annulus</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

    <span class="c1"># check if annulus contains nan values. If so, decrease inner and outer radii by some value and estimate_cont_noise again</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_in_annulus</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\033</span><span class="s1">[93mRegion contains NaNs!</span><span class="se">\033</span><span class="s1">[0m</span><span class="se">\n</span><span class="s1">Making region smaller now...&#39;</span><span class="p">)</span>
        <span class="n">inner_pct</span> <span class="o">-=</span> <span class="mf">0.05</span>
        <span class="n">outer_pct</span> <span class="o">-=</span> <span class="mf">0.05</span>
        <span class="k">return</span> <span class="n">estimate_cont_noise</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">inner_pct</span><span class="p">,</span> <span class="n">outer_pct</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># estimate rms and std in that region</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data_in_annulus</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_in_annulus</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">std, rms = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="n">rms</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">with inner and outer pct: </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inner_pct</span><span class="p">,</span><span class="n">outer_pct</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\033</span><span class="s1">[92mJONAS IS AWESOME</span><span class="se">\033</span><span class="s1">[0m&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">std</span><span class="p">,</span> <span class="n">rms</span></div>
</pre></div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2024, Jonas Syed.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>